<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ç”¨è—¥æ—¥è¨˜ - ä¸»é </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header .icon {
            font-size: 32px;
        }

        .sidebar-header h1 {
            font-size: 20px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            text-decoration: none;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.2);
        }

        .nav-item .icon {
            font-size: 20px;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        /* é ‚éƒ¨æ¬„ */
        .top-bar {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .greeting h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .greeting .date {
            color: #999;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .logout-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #f44336;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .stat-card .icon-box {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .stat-card.today .icon-box { background: #e3f2fd; }
        .stat-card.taken .icon-box { background: #e8f5e9; }
        .stat-card.pending .icon-box { background: #fff3e0; }
        .stat-card.missed .icon-box { background: #ffebee; }

        .stat-card .label {
            color: #999;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
        }

        /* å…§å®¹å€å¡Š */
        .content-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h3 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* è—¥ç‰©æ¸…å–® */
        .med-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .med-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .med-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .med-item.missed {
            border-color: #ffcdd2;
            background: #ffebee;
        }

        .med-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .med-info {
            flex: 1;
        }

        .med-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .med-dosage {
            color: #999;
            font-size: 14px;
        }

        .med-time {
            text-align: right;
        }

        .med-time .time {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .med-time .time-label {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-take {
            background: #4caf50;
            color: white;
        }

        .btn-take:hover {
            background: #45a049;
        }

        .btn-skip {
            background: #ff9800;
            color: white;
        }

        .btn-skip:hover {
            background: #e68900;
        }

        .btn-edit {
            background: #2196f3;
            color: white;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            font-size: 22px;
        }

        .close-btn {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group.reminder-group {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
        }

        .reminder-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .reminder-toggle input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .reminder-settings {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .reminder-settings.active {
            display: block;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            animation: slideIn 0.3s;
        }

        .toast.active {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #4caf50;
        }

        .toast.error {
            border-left: 4px solid #f44336;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* é€šçŸ¥æ¬Šé™æç¤º */
        .notification-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .notification-banner.active {
            display: flex;
        }

        .notification-banner button {
            background: white;
            color: #667eea;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* ç¯©é¸å™¨ */
        .filter-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        /* å ±è¡¨çµ±è¨ˆ */
        .report-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .report-stat-item {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .report-stat-item .label {
            color: #999;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .report-stat-item .value {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .report-stat-item.danger .value {
            color: #f44336;
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- è¼‰å…¥ç•«é¢ -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; color: white;">
        <div style="font-size: 60px; margin-bottom: 20px;">ğŸ’Š</div>
        <h2 style="margin-bottom: 10px;">ç”¨è—¥æ—¥è¨˜</h2>
        <p>è¼‰å…¥ä¸­...</p>
        <div style="width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px;"></div>
    </div>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="icon">ğŸ’Š</span>
            <h1>ç”¨è—¥æ—¥è¨˜</h1>
        </div>
        <nav>
            <div class="nav-item active" onclick="showPage('home')">
                <span class="icon">ğŸ </span>
                <span>é¦–é </span>
            </div>
            <div class="nav-item" onclick="showPage('medicines')">
                <span class="icon">ğŸ’Š</span>
                <span>æˆ‘çš„è—¥ç‰©</span>
            </div>
            <div class="nav-item" onclick="showPage('schedule')">
                <span class="icon">ğŸ“…</span>
                <span>ç”¨è—¥æ’ç¨‹</span>
            </div>
            <div class="nav-item" onclick="showPage('history')">
                <span class="icon">ğŸ“‹</span>
                <span>æœè—¥è¨˜éŒ„</span>
            </div>
            <div class="nav-item" onclick="showPage('missed')">
                <span class="icon">âš ï¸</span>
                <span>å¿˜è¨˜é£Ÿè—¥å ±è¡¨</span>
            </div>
            <div class="nav-item" onclick="showPage('settings')">
                <span class="icon">âš™ï¸</span>
                <span>è¨­å®š</span>
            </div>
        </nav>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- é ‚éƒ¨æ¬„ -->
        <div class="top-bar">
            <div class="greeting">
                <h2 id="userName">è¼‰å…¥ä¸­...</h2>
                <div class="date" id="currentDate"></div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- é€šçŸ¥æ¬Šé™æç¤º -->
        <div class="notification-banner" id="notificationBanner">
            <div>
                <strong>ğŸ”” å•Ÿç”¨æé†’åŠŸèƒ½</strong>
                <p style="font-size: 14px; margin-top: 5px;">å…è¨±é€šçŸ¥ä»¥ä¾¿åœ¨æœè—¥æ™‚é–“å‰æ”¶åˆ°æé†’</p>
            </div>
            <button onclick="requestNotificationPermission()">å•Ÿç”¨</button>
        </div>

        <!-- é¦–é  -->
        <div id="homePage">
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stat-card today">
                    <div class="icon-box">ğŸ“Œ</div>
                    <div class="label">ä»Šæ—¥ç”¨è—¥</div>
                    <div class="value" id="todayTotal">0</div>
                </div>
                <div class="stat-card taken">
                    <div class="icon-box">âœ…</div>
                    <div class="label">å·²æœç”¨</div>
                    <div class="value" id="takenCount">0</div>
                </div>
                <div class="stat-card pending">
                    <div class="icon-box">â°</div>
                    <div class="label">å¾…æœç”¨</div>
                    <div class="value" id="pendingCount">0</div>
                </div>
                <div class="stat-card missed" onclick="showPage('missed')">
                    <div class="icon-box">âš ï¸</div>
                    <div class="label">å·²éŒ¯é</div>
                    <div class="value" id="missedCount">0</div>
                </div>
            </div>

            <!-- ä»Šæ—¥å¾…æœç”¨ -->
            <div class="content-section">
                <div class="section-header">
                    <h3><span>â°</span> ä»Šæ—¥å¾…æœç”¨</h3>
                </div>
                <div id="todayList" class="med-list"></div>
            </div>

            <!-- å³å°‡åˆ°ä¾† -->
            <div class="content-section">
                <div class="section-header">
                    <h3><span>ğŸ”œ</span> å³å°‡åˆ°ä¾†</h3>
                </div>
                <div id="upcomingList" class="med-list"></div>
            </div>
        </div>

        <!-- æˆ‘çš„è—¥ç‰©é é¢ -->
        <div id="medicinesPage" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h3><span>ğŸ’Š</span> æˆ‘çš„è—¥ç‰©æ¸…å–®</h3>
                    <button class="btn-primary" onclick="openAddMedicineModal()">+ æ–°å¢è—¥ç‰©</button>
                </div>
                <div id="medicinesList" class="med-list"></div>
            </div>
        </div>

        <!-- ç”¨è—¥æ’ç¨‹é é¢ -->
        <div id="schedulePage" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h3><span>ğŸ“…</span> ç”¨è—¥æ’ç¨‹</h3>
                </div>
                <div class="filter-group">
                    <select id="scheduleFilter" onchange="renderSchedule()">
                        <option value="7">æœªä¾†7å¤©</option>
                        <option value="14">æœªä¾†14å¤©</option>
                        <option value="30">æœªä¾†30å¤©</option>
                    </select>
                    <select id="scheduleMemberFilter" onchange="renderSchedule()">
                        <option value="all">æ‰€æœ‰æˆå“¡</option>
                        <option value="self">è‡ªå·±</option>
                    </select>
                </div>
                <div id="scheduleList"></div>
            </div>
        </div>

        <!-- æœè—¥è¨˜éŒ„é é¢ -->
        <div id="historyPage" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h3><span>ğŸ“‹</span> æœè—¥è¨˜éŒ„</h3>
                </div>
                <div class="filter-group">
                    <select id="historyFilter" onchange="loadHistory()">
                        <option value="7">éå»7å¤©</option>
                        <option value="14">éå»14å¤©</option>
                        <option value="30">éå»30å¤©</option>
                        <option value="all">å…¨éƒ¨è¨˜éŒ„</option>
                    </select>
                    <select id="historyMemberFilter" onchange="loadHistory()">
                        <option value="all">æ‰€æœ‰æˆå“¡</option>
                        <option value="self">è‡ªå·±</option>
                    </select>
                </div>
                <div id="historyList"></div>
            </div>
        </div>

        <!-- å¿˜è¨˜é£Ÿè—¥å ±è¡¨é é¢ -->
        <div id="missedPage" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h3><span>âš ï¸</span> å¿˜è¨˜é£Ÿè—¥å ±è¡¨</h3>
                </div>
                
                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="report-stats">
                    <div class="report-stat-item danger">
                        <div class="label">éŒ¯éæ¬¡æ•¸</div>
                        <div class="value" id="totalMissed">0</div>
                    </div>
                    <div class="report-stat-item">
                        <div class="label">éµå¾ç‡</div>
                        <div class="value" id="complianceRate">100%</div>
                    </div>
                    <div class="report-stat-item danger">
                        <div class="label">æœ€å¸¸éŒ¯é</div>
                        <div class="value" id="mostMissedMed" style="font-size: 16px;">-</div>
                    </div>
                </div>

                <!-- ç¯©é¸å™¨ -->
                <div class="filter-group">
                    <select id="missedFilter" onchange="loadMissedReport()">
                        <option value="7">éå»7å¤©</option>
                        <option value="14">éå»14å¤©</option>
                        <option value="30">éå»30å¤©</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                    <select id="missedMemberFilter" onchange="loadMissedReport()">
                        <option value="all">æ‰€æœ‰æˆå“¡</option>
                        <option value="self">è‡ªå·±</option>
                    </select>
                </div>

                <!-- éŒ¯éè¨˜éŒ„åˆ—è¡¨ -->
                <div id="missedList"></div>
            </div>
        </div>

        <!-- è¨­å®šé é¢ -->
        <div id="settingsPage" style="display: none;">
            <div class="content-section">
                <div class="section-header">
                    <h3><span>âš™ï¸</span> ç³»çµ±è¨­å®š</h3>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“§ é›»å­éƒµä»¶</label>
                    <input type="email" id="settingsEmail" readonly>
                </div>

                <div class="form-group">
                    <label>ğŸ‘¤ é¡¯ç¤ºåç¨±</label>
                    <input type="text" id="settingsName" placeholder="è¼¸å…¥æ‚¨çš„åç¨±">
                </div>

                <div class="form-group reminder-group">
                    <label>ğŸ”” æé†’è¨­å®š</label>
                    <div class="reminder-toggle">
                        <input type="checkbox" id="enableReminders" onchange="toggleReminderSettings()">
                        <label for="enableReminders" style="margin: 0;">å•Ÿç”¨æœè—¥æé†’</label>
                    </div>
                    <div id="reminderSettings" class="reminder-settings">
                        <div class="form-group">
                            <label>æå‰æé†’æ™‚é–“ï¼ˆåˆ†é˜ï¼‰</label>
                            <select id="reminderMinutes">
                                <option value="0">æº–æ™‚æé†’</option>
                                <option value="5">æå‰5åˆ†é˜</option>
                                <option value="10">æå‰10åˆ†é˜</option>
                                <option value="15" selected>æå‰15åˆ†é˜</option>
                                <option value="30">æå‰30åˆ†é˜</option>
                                <option value="60">æå‰1å°æ™‚</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="soundEnabled" checked>
                                æé†’éŸ³æ•ˆ
                            </label>
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="saveSettings()" style="width: 100%; margin-top: 20px;">
                    ğŸ’¾ å„²å­˜è¨­å®š
                </button>
            </div>

            <!-- å®¶åº­æˆå“¡ç®¡ç† -->
            <div class="content-section">
                <div class="section-header">
                    <h3><span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span> å®¶åº­æˆå“¡</h3>
                    <button class="btn-primary" onclick="openAddMemberModal()">+ æ–°å¢æˆå“¡</button>
                </div>
                <div id="membersList" class="med-list"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è—¥ç‰© Modal -->
    <div id="addMedicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’Š æ–°å¢è—¥ç‰©</h3>
                <span class="close-btn" onclick="closeAddMedicineModal()">&times;</span>
            </div>
            <form onsubmit="handleAddMedicine(event)">
                <div class="form-group">
                    <label>è—¥ç‰©åç¨± *</label>
                    <input type="text" id="medName" required>
                </div>
                <div class="form-group">
                    <label>åŠ‘é‡èªªæ˜ *</label>
                    <input type="text" id="medDosage" placeholder="ä¾‹å¦‚ï¼š1é¡†ã€5ml" required>
                </div>
                <div class="form-group">
                    <label>æœç”¨æ™‚é–“ *</label>
                    <input type="time" id="medTime" required>
                </div>
                <div class="form-group">
                    <label>æœç”¨é »ç‡</label>
                    <select id="medFrequency">
                        <option value="daily">æ¯æ—¥</option>
                        <option value="weekly">æ¯é€±</option>
                        <option value="asNeeded">éœ€è¦æ™‚</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é–‹å§‹æ—¥æœŸ</label>
                    <input type="date" id="medStartDate" required>
                </div>
                <div class="form-group">
                    <label>çµæŸæ—¥æœŸï¼ˆå¯é¸ï¼‰</label>
                    <input type="date" id="medEndDate">
                </div>
                <div class="form-group">
                    <label>æœç”¨å°è±¡</label>
                    <select id="medMember">
                        <option value="self">è‡ªå·±</option>
                    </select>
                </div>
                <div class="form-group reminder-group">
                    <div class="reminder-toggle">
                        <input type="checkbox" id="medReminder" checked>
                        <label for="medReminder" style="margin: 0;">å•Ÿç”¨æ­¤è—¥ç‰©çš„æé†’</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="medNotes" rows="3" placeholder="ä¾‹å¦‚ï¼šé£¯å¾Œæœç”¨ã€é¿å…èˆ‡å’–å•¡åŒæœ"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">æ–°å¢è—¥ç‰©</button>
            </form>
        </div>
    </div>

    <!-- æ–°å¢æˆå“¡ Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ‘¤ æ–°å¢å®¶åº­æˆå“¡</h3>
                <span class="close-btn" onclick="closeAddMemberModal()">&times;</span>
            </div>
            <form onsubmit="handleAddMember(event)">
                <div class="form-group">
                    <label>æˆå“¡å§“å *</label>
                    <input type="text" id="memberName" required>
                </div>
                <div class="form-group">
                    <label>é—œä¿‚</label>
                    <input type="text" id="memberRelation" placeholder="ä¾‹å¦‚ï¼šé…å¶ã€å­å¥³ã€çˆ¶æ¯">
                </div>
                <button type="submit" class="btn-primary" style="width: 100%;">æ–°å¢æˆå“¡</button>
            </form>
        </div>
    </div>

    <!-- Toast é€šçŸ¥ -->
    <div id="toast" class="toast">
        <span id="toastIcon">âœ…</span>
        <span id="toastMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyABGt37A7Vq9S5UrAf28pWBFZPVuJ-3RLo",
            authDomain: "mymedlog.firebaseapp.com",
            projectId: "mymedlog",
            storageBucket: "mymedlog.firebasestorage.app",
            messagingSenderId: "926334827314",
            appId: "1:926334827314:web:5fc38ee464eb1dd965b52b",
            measurementId: "G-753S8BWFDD"
        };

        // åˆå§‹åŒ– Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // å…¨åŸŸè®Šæ•¸
        let currentUser = null;
        let medicines = [];
        let familyMembers = [];
        let todayRecords = [];
        let userSettings = {
            enableReminders: true,
            reminderMinutes: 15,
            soundEnabled: true
        };
        let reminderCheckInterval = null;

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = user;
            console.log('âœ… å·²ç™»å…¥:', user.email);
            
            // åˆå§‹åŒ–é é¢
            await initializePage();
            
            // æª¢æŸ¥é€šçŸ¥æ¬Šé™
            checkNotificationPermission();
            
            // å•Ÿå‹•æé†’æª¢æŸ¥
            startReminderCheck();
        });

        // åˆå§‹åŒ–é é¢
        async function initializePage() {
            try {
                // è¨­å®šä½¿ç”¨è€…è³‡è¨Š
                const userName = currentUser.displayName || currentUser.email.split('@')[0];
                document.getElementById('userName').textContent = `ä½ å¥½ï¼Œ${userName}ï¼`;
                document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                
                // è¨­å®šæ—¥æœŸ
                const today = new Date();
                document.getElementById('currentDate').textContent = today.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });

                // è¼‰å…¥ä½¿ç”¨è€…è¨­å®š
                await loadUserSettings();
                
                // è¼‰å…¥è³‡æ–™
                await loadFamilyMembers();
                await loadMedicines();
                await loadTodayRecords();
                
                // æ›´æ–°é¦–é 
                updateHomePage();
                
                // ç§»é™¤è¼‰å…¥ç•«é¢
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    loadingScreen.style.transition = 'opacity 0.3s';
                    setTimeout(() => loadingScreen.remove(), 300);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                showToast('åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                // ä»ç„¶ç§»é™¤è¼‰å…¥ç•«é¢
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) loadingScreen.remove();
            }
        }

        // è¼‰å…¥ä½¿ç”¨è€…è¨­å®š
        async function loadUserSettings() {
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    userSettings = {
                        enableReminders: data.enableReminders !== false,
                        reminderMinutes: data.reminderMinutes || 15,
                        soundEnabled: data.soundEnabled !== false
                    };
                    
                    // æ›´æ–°è¨­å®šé é¢
                    document.getElementById('settingsEmail').value = currentUser.email;
                    document.getElementById('settingsName').value = data.name || '';
                    document.getElementById('enableReminders').checked = userSettings.enableReminders;
                    document.getElementById('reminderMinutes').value = userSettings.reminderMinutes;
                    document.getElementById('soundEnabled').checked = userSettings.soundEnabled;
                    
                    if (userSettings.enableReminders) {
                        document.getElementById('reminderSettings').classList.add('active');
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šéŒ¯èª¤:', error);
            }
        }

        // å„²å­˜è¨­å®š
        async function saveSettings() {
            const name = document.getElementById('settingsName').value.trim();
            const enableReminders = document.getElementById('enableReminders').checked;
            const reminderMinutes = parseInt(document.getElementById('reminderMinutes').value);
            const soundEnabled = document.getElementById('soundEnabled').checked;

            try {
                // æ›´æ–° Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    name: name,
                    enableReminders: enableReminders,
                    reminderMinutes: reminderMinutes,
                    soundEnabled: soundEnabled
                });

                // æ›´æ–°ä½¿ç”¨è€…åç¨±
                if (name) {
                    await currentUser.updateProfile({ displayName: name });
                    document.getElementById('userName').textContent = `ä½ å¥½ï¼Œ${name}ï¼`;
                    document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
                }

                // æ›´æ–°å…¨åŸŸè¨­å®š
                userSettings = { enableReminders, reminderMinutes, soundEnabled };

                showToast('è¨­å®šå·²å„²å­˜', 'success');
            } catch (error) {
                console.error('å„²å­˜è¨­å®šéŒ¯èª¤:', error);
                showToast('å„²å­˜å¤±æ•—', 'error');
            }
        }

        // åˆ‡æ›æé†’è¨­å®šé¡¯ç¤º
        function toggleReminderSettings() {
            const enabled = document.getElementById('enableReminders').checked;
            const settings = document.getElementById('reminderSettings');
            
            if (enabled) {
                settings.classList.add('active');
            } else {
                settings.classList.remove('active');
            }
        }

        // æª¢æŸ¥é€šçŸ¥æ¬Šé™
        function checkNotificationPermission() {
            if (!('Notification' in window)) {
                return;
            }

            if (Notification.permission === 'default') {
                document.getElementById('notificationBanner').classList.add('active');
            }
        }

        // è«‹æ±‚é€šçŸ¥æ¬Šé™
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½', 'error');
                return;
            }

            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                document.getElementById('notificationBanner').classList.remove('active');
                showToast('é€šçŸ¥å·²å•Ÿç”¨ï¼', 'success');
            } else {
                showToast('æ‚¨æ‹’çµ•äº†é€šçŸ¥æ¬Šé™', 'error');
            }
        }

        // å•Ÿå‹•æé†’æª¢æŸ¥ï¼ˆæ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ï¼‰
        function startReminderCheck() {
            // æ¸…é™¤èˆŠçš„å®šæ™‚å™¨
            if (reminderCheckInterval) {
                clearInterval(reminderCheckInterval);
            }

            // ç«‹å³æª¢æŸ¥ä¸€æ¬¡
            checkReminders();

            // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
            reminderCheckInterval = setInterval(checkReminders, 60000);
        }

        // æª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€æé†’
        async function checkReminders() {
            try {
                if (!userSettings.enableReminders) return;
                if (!('Notification' in window)) return;
                if (Notification.permission !== 'granted') return;
                if (!medicines || medicines.length === 0) return;

                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                
                // è¨ˆç®—æé†’æ™‚é–“
                const reminderTime = new Date(now.getTime() + userSettings.reminderMinutes * 60000);
                const reminderTimeStr = `${String(reminderTime.getHours()).padStart(2, '0')}:${String(reminderTime.getMinutes()).padStart(2, '0')}`;

                // æª¢æŸ¥ä»Šå¤©é‚„æœªæœç”¨çš„è—¥ç‰©
                for (const med of medicines) {
                    if (!med.reminderEnabled && med.reminderEnabled !== undefined) continue;
                    
                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœç”¨
                    const alreadyTaken = todayRecords.some(r => r.medicineId === med.id);
                    if (alreadyTaken) continue;

                    // æª¢æŸ¥æ™‚é–“æ˜¯å¦åŒ¹é…
                    if (med.time === reminderTimeStr || med.time === currentTime) {
                        sendNotification(med);
                    }
                }
            } catch (error) {
                console.error('æª¢æŸ¥æé†’éŒ¯èª¤:', error);
            }
        }

        // ç™¼é€é€šçŸ¥
        function sendNotification(medicine) {
            try {
                const member = familyMembers.find(m => m.id === medicine.member);
                const memberText = (member && member.id !== 'self') ? ` (${member.name})` : '';
                
                const notification = new Notification('â° ç”¨è—¥æé†’', {
                    body: `è©²æœç”¨ ${medicine.name}${memberText} äº†ï¼\nåŠ‘é‡ï¼š${medicine.dosage}`,
                    icon: 'ğŸ’Š',
                    tag: medicine.id, // é¿å…é‡è¤‡é€šçŸ¥
                    requireInteraction: true
                });

                // æ’­æ”¾æé†’éŸ³æ•ˆ
                if (userSettings.soundEnabled) {
                    playReminderSound();
                }

                notification.onclick = () => {
                    window.focus();
                    notification.close();
                    showPage('home');
                };
            } catch (error) {
                console.error('ç™¼é€é€šçŸ¥éŒ¯èª¤:', error);
            }
        }

        // æ’­æ”¾æé†’éŸ³æ•ˆ
        function playReminderSound() {
            // ä½¿ç”¨ Web Audio API ç”¢ç”Ÿç°¡å–®çš„æç¤ºéŸ³
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (error) {
                console.error('æ’­æ”¾æé†’éŸ³æ•ˆéŒ¯èª¤:', error);
            }
        }

        // è¼‰å…¥å®¶åº­æˆå“¡
        async function loadFamilyMembers() {
            try {
                const snapshot = await db.collection('members')
                    .where('userId', '==', currentUser.uid)
                    .get();
                
                familyMembers = [{
                    id: 'self',
                    name: 'è‡ªå·±',
                    relation: ''
                }];
                
                snapshot.forEach(doc => {
                    familyMembers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                updateMemberSelects();
                renderMembersList();
            } catch (error) {
                console.error('è¼‰å…¥å®¶åº­æˆå“¡éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°æˆå“¡ä¸‹æ‹‰é¸å–®
        function updateMemberSelects() {
            const selects = ['medMember', 'scheduleMemberFilter', 'historyMemberFilter', 'missedMemberFilter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                const isFilter = selectId.includes('Filter');
                
                select.innerHTML = isFilter ? '<option value="all">æ‰€æœ‰æˆå“¡</option>' : '';
                
                familyMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    select.appendChild(option);
                });
                
                if (currentValue && Array.from(select.options).some(o => o.value === currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        // æ¸²æŸ“æˆå“¡åˆ—è¡¨
        function renderMembersList() {
            const container = document.getElementById('membersList');
            const members = familyMembers.filter(m => m.id !== 'self');
            
            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
                        <p>å°šæœªæ–°å¢å®¶åº­æˆå“¡</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = members.map(member => `
                <div class="med-item">
                    <div class="med-icon" style="background: #2196f3;">ğŸ‘¤</div>
                    <div class="med-info">
                        <div class="med-name">${member.name}</div>
                        <div class="med-dosage">${member.relation || 'å®¶åº­æˆå“¡'}</div>
                    </div>
                    <button class="action-btn btn-delete" onclick="deleteMember('${member.id}')">åˆªé™¤</button>
                </div>
            `).join('');
        }

        // è¼‰å…¥è—¥ç‰©
        async function loadMedicines() {
            try {
                const snapshot = await db.collection('medicines')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                medicines = [];
                snapshot.forEach(doc => {
                    medicines.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                renderMedicinesList();
            } catch (error) {
                console.error('è¼‰å…¥è—¥ç‰©éŒ¯èª¤:', error);
            }
        }

        // æ¸²æŸ“è—¥ç‰©åˆ—è¡¨
        function renderMedicinesList() {
            const container = document.getElementById('medicinesList');
            
            if (medicines.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ’Š</div>
                        <p>å°šæœªæ–°å¢ä»»ä½•è—¥ç‰©</p>
                        <p style="font-size: 14px; margin-top: 10px;">é»æ“Šå³ä¸Šè§’ã€Œæ–°å¢è—¥ç‰©ã€é–‹å§‹è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = medicines.map(med => {
                const member = familyMembers.find(m => m.id === med.member);
                const memberBadge = member && member.id !== 'self' 
                    ? `<span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">${member.name}</span>`
                    : '';
                
                const reminderBadge = med.reminderEnabled !== false
                    ? `<span style="background: #e8f5e9; color: #4caf50; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">ğŸ”” å·²å•Ÿç”¨æé†’</span>`
                    : '';

                return `
                    <div class="med-item">
                        <div class="med-icon">ğŸ’Š</div>
                        <div class="med-info">
                            <div class="med-name">${med.name}${memberBadge}${reminderBadge}</div>
                            <div class="med-dosage">${med.dosage} â€¢ ${getFrequencyText(med.frequency)} â€¢ ${med.time}</div>
                            ${med.notes ? `<div class="med-dosage" style="margin-top: 5px;">ğŸ“ ${med.notes}</div>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn btn-edit" onclick="editMedicine('${med.id}')">ç·¨è¼¯</button>
                            <button class="action-btn btn-delete" onclick="deleteMedicine('${med.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // è¼‰å…¥ä»Šæ—¥è¨˜éŒ„
        async function loadTodayRecords() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const snapshot = await db.collection('records')
                    .where('userId', '==', currentUser.uid)
                    .where('date', '==', today)
                    .get();
                
                todayRecords = [];
                snapshot.forEach(doc => {
                    todayRecords.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
            } catch (error) {
                console.error('è¼‰å…¥ä»Šæ—¥è¨˜éŒ„éŒ¯èª¤:', error);
            }
        }

        // æ›´æ–°é¦–é 
        function updateHomePage() {
            // ç¢ºä¿è³‡æ–™å·²è¼‰å…¥
            if (!medicines || medicines.length === 0) {
                document.getElementById('todayTotal').textContent = '0';
                document.getElementById('takenCount').textContent = '0';
                document.getElementById('pendingCount').textContent = '0';
                document.getElementById('missedCount').textContent = '0';
                
                document.getElementById('todayList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ’Š</div>
                        <p>å°šæœªæ–°å¢ä»»ä½•è—¥ç‰©</p>
                        <p style="font-size: 14px; margin-top: 10px;">å‰å¾€ã€Œæˆ‘çš„è—¥ç‰©ã€æ–°å¢ç¬¬ä¸€å€‹è—¥ç‰©</p>
                    </div>
                `;
                
                document.getElementById('upcomingList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ“…</div>
                        <p>ç„¡å³å°‡åˆ°ä¾†çš„ç”¨è—¥</p>
                    </div>
                `;
                return;
            }

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const currentTime = `${String(today.getHours()).padStart(2, '0')}:${String(today.getMinutes()).padStart(2, '0')}`;

            // ä»Šæ—¥è—¥ç‰©ï¼ˆæ ¹æ“šçµæŸæ—¥æœŸéæ¿¾ï¼‰
            const todayMeds = medicines.filter(med => {
                if (med.endDate && med.endDate < todayStr) return false;
                if (med.startDate && med.startDate > todayStr) return false;
                if (med.frequency === 'asNeeded') return false;
                return true;
            });

            // å·²æœç”¨æ•¸é‡
            const takenCount = todayRecords.length;
            
            // å¾…æœç”¨åˆ—è¡¨
            const pending = todayMeds.filter(med => 
                !todayRecords.some(r => r.medicineId === med.id)
            );

            // å·²éŒ¯éï¼ˆæ™‚é–“å·²éä½†æœªæœç”¨ï¼‰
            const missed = pending.filter(med => med.time < currentTime);

            // æ›´æ–°çµ±è¨ˆ
            document.getElementById('todayTotal').textContent = todayMeds.length;
            document.getElementById('takenCount').textContent = takenCount;
            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('missedCount').textContent = missed.length;

            // æ¸²æŸ“å¾…æœç”¨åˆ—è¡¨
            renderTodayList(pending);
            
            // æ¸²æŸ“å³å°‡åˆ°ä¾†
            renderUpcomingList(pending);
        }

        // æ¸²æŸ“ä»Šæ—¥å¾…æœç”¨
        function renderTodayList(pending) {
            const container = document.getElementById('todayList');
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âœ…</div>
                        <p>ä»Šæ—¥æ‰€æœ‰è—¥ç‰©éƒ½å·²æœç”¨å®Œç•¢ï¼</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pending
                .sort((a, b) => a.time.localeCompare(b.time))
                .map(med => {
                    const member = familyMembers.find(m => m.id === med.member);
                    const memberBadge = member && member.id !== 'self' 
                        ? ` <span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${member.name}</span>`
                        : '';
                    
                    const isMissed = med.time < currentTime;
                    const itemClass = isMissed ? 'med-item missed' : 'med-item';

                    return `
                        <div class="${itemClass}">
                            <div class="med-icon">${isMissed ? 'âš ï¸' : 'ğŸ’Š'}</div>
                            <div class="med-info">
                                <div class="med-name">${med.name}${memberBadge}</div>
                                <div class="med-dosage">${med.dosage}${isMissed ? ' â€¢ å·²éŒ¯é' : ''}</div>
                            </div>
                            <div class="med-time">
                                <div class="time">${med.time}</div>
                                <div class="time-label">${getTimeLabel(med.time)}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="action-btn btn-take" onclick="takeMedicine('${med.id}')">âœ“ å·²æœç”¨</button>
                                <button class="action-btn btn-skip" onclick="skipMedicine('${med.id}')">è·³é</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // æ¸²æŸ“å³å°‡åˆ°ä¾†
        function renderUpcomingList(pending) {
            const container = document.getElementById('upcomingList');
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            const upcoming = pending
                .filter(med => med.time >= currentTime)
                .sort((a, b) => a.time.localeCompare(b.time))
                .slice(0, 3);

            if (upcoming.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ˜´</div>
                        <p>ä»Šæ—¥æ²’æœ‰æ›´å¤šå¾…æœç”¨çš„è—¥ç‰©</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = upcoming.map(med => {
                const member = familyMembers.find(m => m.id === med.member);
                const memberBadge = member && member.id !== 'self' 
                    ? ` <span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${member.name}</span>`
                    : '';

                return `
                    <div class="med-item">
                        <div class="med-icon">â°</div>
                        <div class="med-info">
                            <div class="med-name">${med.name}${memberBadge}</div>
                            <div class="med-dosage">${med.dosage}</div>
                        </div>
                        <div class="med-time">
                            <div class="time">${med.time}</div>
                            <div class="time-label">${getTimeLabel(med.time)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æœç”¨è—¥ç‰©
        async function takeMedicine(medicineId) {
            try {
                const medicine = medicines.find(m => m.id === medicineId);
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                const actualTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

                await db.collection('records').add({
                    userId: currentUser.uid,
                    medicineId: medicineId,
                    date: today,
                    time: medicine.time,
                    actualTime: actualTime,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await loadTodayRecords();
                updateHomePage();
                showToast('âœ… å·²è¨˜éŒ„æœè—¥', 'success');
            } catch (error) {
                console.error('è¨˜éŒ„æœè—¥éŒ¯èª¤:', error);
                showToast('è¨˜éŒ„å¤±æ•—', 'error');
            }
        }

        // è·³éè—¥ç‰©
        async function skipMedicine(medicineId) {
            if (!confirm('ç¢ºå®šè¦è·³éé€™æ¬¡æœè—¥å—ï¼Ÿ')) return;

            try {
                const medicine = medicines.find(m => m.id === medicineId);
                const now = new Date();
                const today = now.toISOString().split('T')[0];

                // è¨˜éŒ„ç‚ºéŒ¯é
                await db.collection('missed').add({
                    userId: currentUser.uid,
                    medicineId: medicineId,
                    date: today,
                    time: medicine.time,
                    reason: 'skipped',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await loadTodayRecords();
                updateHomePage();
                showToast('å·²è·³éæ­¤æ¬¡æœè—¥', 'success');
            } catch (error) {
                console.error('è¨˜éŒ„è·³ééŒ¯èª¤:', error);
                showToast('æ“ä½œå¤±æ•—', 'error');
            }
        }

        // è¼‰å…¥å¿˜è¨˜é£Ÿè—¥å ±è¡¨
        async function loadMissedReport() {
            const filter = document.getElementById('missedFilter').value;
            const memberFilter = document.getElementById('missedMemberFilter').value;
            
            try {
                // è¨ˆç®—æ—¥æœŸç¯„åœ
                let startDate = new Date();
                if (filter !== 'all') {
                    startDate.setDate(startDate.getDate() - parseInt(filter));
                }

                // è¼‰å…¥éŒ¯éè¨˜éŒ„
                const missedSnapshot = await db.collection('missed')
                    .where('userId', '==', currentUser.uid)
                    .get();

                const missedRecords = [];
                missedSnapshot.forEach(doc => {
                    const data = doc.data();
                    const recordDate = new Date(data.date);
                    if (filter === 'all' || recordDate >= startDate) {
                        missedRecords.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // æˆå“¡ç¯©é¸
                const filteredRecords = missedRecords.filter(record => {
                    const medicine = medicines.find(m => m.id === record.medicineId);
                    if (!medicine) return false;
                    if (memberFilter === 'all') return true;
                    return medicine.member === memberFilter;
                });

                // è¨ˆç®—çµ±è¨ˆ
                const totalMissed = filteredRecords.length;
                
                // è¨ˆç®—éµå¾ç‡ï¼ˆéœ€è¦ç¸½è¨ˆåŠƒæ¬¡æ•¸ï¼‰
                const totalPlanned = await calculatePlannedDoses(startDate, filter);
                const complianceRate = totalPlanned > 0 
                    ? Math.round((1 - totalMissed / totalPlanned) * 100)
                    : 100;

                // æ‰¾å‡ºæœ€å¸¸éŒ¯éçš„è—¥ç‰©
                const medCounts = {};
                filteredRecords.forEach(record => {
                    medCounts[record.medicineId] = (medCounts[record.medicineId] || 0) + 1;
                });
                
                const mostMissedId = Object.keys(medCounts).reduce((a, b) => 
                    medCounts[a] > medCounts[b] ? a : b, null);
                
                const mostMissedMed = mostMissedId 
                    ? medicines.find(m => m.id === mostMissedId)?.name || '-'
                    : '-';

                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('totalMissed').textContent = totalMissed;
                document.getElementById('complianceRate').textContent = complianceRate + '%';
                document.getElementById('mostMissedMed').textContent = mostMissedMed;

                // æ¸²æŸ“åˆ—è¡¨
                renderMissedList(filteredRecords);

            } catch (error) {
                console.error('è¼‰å…¥å¿˜è¨˜é£Ÿè—¥å ±è¡¨éŒ¯èª¤:', error);
                document.getElementById('totalMissed').textContent = '0';
                document.getElementById('complianceRate').textContent = '100%';
                document.getElementById('mostMissedMed').textContent = '-';
                document.getElementById('missedList').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <p>è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        // è¨ˆç®—è¨ˆåŠƒåŠ‘é‡ç¸½æ•¸
        async function calculatePlannedDoses(startDate, filter) {
            const endDate = new Date();
            const days = filter === 'all' ? 365 : parseInt(filter);
            
            let total = 0;
            medicines.forEach(med => {
                if (med.frequency === 'asNeeded') return;
                
                const medStart = med.startDate ? new Date(med.startDate) : new Date(0);
                const medEnd = med.endDate ? new Date(med.endDate) : endDate;
                
                const effectiveStart = medStart > startDate ? medStart : startDate;
                const effectiveEnd = medEnd < endDate ? medEnd : endDate;
                
                if (effectiveStart <= effectiveEnd) {
                    const daysActive = Math.floor((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24)) + 1;
                    total += daysActive;
                }
            });
            
            return total;
        }

        // æ¸²æŸ“éŒ¯éåˆ—è¡¨
        function renderMissedList(records) {
            const container = document.getElementById('missedList');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‰</div>
                        <p>å¤ªæ£’äº†ï¼æ­¤æœŸé–“æ²’æœ‰éŒ¯éä»»ä½•è—¥ç‰©</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†çµ„
            const recordsByDate = {};
            records.forEach(record => {
                const dateKey = record.date;
                if (!recordsByDate[dateKey]) {
                    const date = new Date(dateKey);
                    recordsByDate[dateKey] = {
                        display: date.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            weekday: 'short'
                        }),
                        records: []
                    };
                }
                
                const medicine = medicines.find(m => m.id === record.medicineId);
                if (medicine) {
                    recordsByDate[dateKey].records.push({
                        ...record,
                        medicineName: medicine.name,
                        dosage: medicine.dosage,
                        member: medicine.member
                    });
                }
            });

            // æ¸²æŸ“
            let html = '';
            Object.keys(recordsByDate).sort().reverse().forEach(dateKey => {
                const day = recordsByDate[dateKey];
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #666; margin-bottom: 15px; font-size: 16px;">
                            ${day.display}
                        </h4>
                        <div class="med-list">
                            ${day.records.map(record => {
                                const member = familyMembers.find(m => m.id === record.member);
                                const memberBadge = member && member.id !== 'self' 
                                    ? ` <span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${member.name}</span>`
                                    : '';

                                return `
                                    <div class="med-item missed">
                                        <div class="med-icon" style="background: #f44336;">âš ï¸</div>
                                        <div class="med-info">
                                            <div class="med-name">${record.medicineName}${memberBadge}</div>
                                            <div class="med-dosage">${record.dosage} â€¢ è¨ˆåŠƒæ™‚é–“: ${record.time}</div>
                                        </div>
                                        <div class="med-time">
                                            <div class="time">${record.time}</div>
                                            <div class="time-label">å·²éŒ¯é</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Modal æ“ä½œ
        function openAddMedicineModal() {
            document.getElementById('medStartDate').valueAsDate = new Date();
            document.getElementById('addMedicineModal').classList.add('active');
        }

        function closeAddMedicineModal() {
            document.getElementById('addMedicineModal').classList.remove('active');
            document.querySelector('#addMedicineModal form').reset();
        }

        function openAddMemberModal() {
            document.getElementById('addMemberModal').classList.add('active');
        }

        function closeAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('active');
            document.querySelector('#addMemberModal form').reset();
        }

        // æ–°å¢è—¥ç‰©
        async function handleAddMedicine(event) {
            event.preventDefault();
            
            const data = {
                userId: currentUser.uid,
                name: document.getElementById('medName').value.trim(),
                dosage: document.getElementById('medDosage').value.trim(),
                time: document.getElementById('medTime').value,
                frequency: document.getElementById('medFrequency').value,
                startDate: document.getElementById('medStartDate').value,
                endDate: document.getElementById('medEndDate').value || null,
                member: document.getElementById('medMember').value,
                reminderEnabled: document.getElementById('medReminder').checked,
                notes: document.getElementById('medNotes').value.trim() || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('medicines').add(data);
                await loadMedicines();
                updateHomePage();
                closeAddMedicineModal();
                showToast('âœ… è—¥ç‰©å·²æ–°å¢', 'success');
            } catch (error) {
                console.error('æ–°å¢è—¥ç‰©éŒ¯èª¤:', error);
                showToast('æ–°å¢å¤±æ•—', 'error');
            }
        }

        // æ–°å¢æˆå“¡
        async function handleAddMember(event) {
            event.preventDefault();
            
            const data = {
                userId: currentUser.uid,
                name: document.getElementById('memberName').value.trim(),
                relation: document.getElementById('memberRelation').value.trim() || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('members').add(data);
                await loadFamilyMembers();
                closeAddMemberModal();
                showToast('âœ… æˆå“¡å·²æ–°å¢', 'success');
            } catch (error) {
                console.error('æ–°å¢æˆå“¡éŒ¯èª¤:', error);
                showToast('æ–°å¢å¤±æ•—', 'error');
            }
        }

        // åˆªé™¤è—¥ç‰©
        async function deleteMedicine(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è—¥ç‰©å—ï¼Ÿ')) return;

            try {
                await db.collection('medicines').doc(id).delete();
                await loadMedicines();
                updateHomePage();
                showToast('è—¥ç‰©å·²åˆªé™¤', 'success');
            } catch (error) {
                console.error('åˆªé™¤è—¥ç‰©éŒ¯èª¤:', error);
                showToast('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // åˆªé™¤æˆå“¡
        async function deleteMember(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æˆå“¡å—ï¼Ÿ')) return;

            try {
                await db.collection('members').doc(id).delete();
                await loadFamilyMembers();
                showToast('æˆå“¡å·²åˆªé™¤', 'success');
            } catch (error) {
                console.error('åˆªé™¤æˆå“¡éŒ¯èª¤:', error);
                showToast('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        // æ¸²æŸ“æ’ç¨‹ï¼ˆå¾åŸæª”æ¡ˆè¤‡è£½ï¼‰
        async function renderSchedule() {
            const filter = document.getElementById('scheduleFilter').value;
            const memberFilter = document.getElementById('scheduleMemberFilter').value;
            const container = document.getElementById('scheduleList');
            
            const days = parseInt(filter);
            const schedule = {};
            
            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                
                schedule[dateStr] = {
                    display: date.toLocaleDateString('zh-TW', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        weekday: 'short'
                    }),
                    isToday: i === 0,
                    items: []
                };
            }
            
            medicines.forEach(med => {
                if (med.frequency === 'asNeeded') return;
                if (memberFilter !== 'all' && med.member !== memberFilter) return;
                
                Object.keys(schedule).forEach(dateStr => {
                    if (med.endDate && dateStr > med.endDate) return;
                    if (med.startDate && dateStr < med.startDate) return;
                    
                    schedule[dateStr].items.push({
                        name: med.name,
                        dosage: med.dosage,
                        time: med.time,
                        member: med.member
                    });
                });
            });

            const getMemberBadge = (memberId) => {
                if (memberId === 'self' || memberFilter !== 'all') return '';
                const member = familyMembers.find(m => m.id === memberId);
                return member ? ` <span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${member.name}</span>` : '';
            };

            let html = '';
            Object.keys(schedule).forEach(dateKey => {
                const day = schedule[dateKey];
                if (day.items.length === 0) return;
                
                day.items.sort((a, b) => a.time.localeCompare(b.time));
                
                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #666; margin-bottom: 15px; font-size: 16px;">
                            ${day.isToday ? 'ğŸ“ ' : ''}${day.display}
                        </h4>
                        <div class="med-list">
                            ${day.items.map(item => `
                                <div class="med-item">
                                    <div class="med-icon">ğŸ’Š</div>
                                    <div class="med-info">
                                        <div class="med-name">${item.name}${getMemberBadge(item.member)}</div>
                                        <div class="med-dosage">${item.dosage}</div>
                                    </div>
                                    <div class="med-time">
                                        <div class="time">${item.time}</div>
                                        <div class="time-label">${getTimeLabel(item.time)}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || `
                <div class="empty-state">
                    <div class="icon">ğŸ“…</div>
                    <p>æ­¤æœŸé–“ç„¡ç”¨è—¥æ’ç¨‹</p>
                </div>
            `;
        }

        // è¼‰å…¥æ­·å²è¨˜éŒ„ï¼ˆå¾åŸæª”æ¡ˆè¤‡è£½ï¼‰
        async function loadHistory() {
            const container = document.getElementById('historyList');
            const filter = document.getElementById('historyFilter').value;
            const memberFilter = document.getElementById('historyMemberFilter').value;
            
            try {
                let startDate = new Date();
                if (filter !== 'all') {
                    startDate.setDate(startDate.getDate() - parseInt(filter));
                } else {
                    startDate = new Date(2020, 0, 1);
                }

                const snapshot = await db.collection('records')
                    .where('userId', '==', currentUser.uid)
                    .get();

                const records = [];
                snapshot.forEach(doc => {
                    const record = doc.data();
                    const recordDate = new Date(record.date);
                    if (recordDate >= startDate) {
                        records.push({
                            id: doc.id,
                            ...record
                        });
                    }
                });

                records.sort((a, b) => {
                    if (b.createdAt && a.createdAt) {
                        return b.createdAt.toMillis() - a.createdAt.toMillis();
                    }
                    return new Date(b.date) - new Date(a.date);
                });

                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>æ­¤æœŸé–“ç„¡æœè—¥è¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }

                const recordsByDate = {};
                records.forEach(record => {
                    const dateKey = record.date;
                    if (!recordsByDate[dateKey]) {
                        const date = new Date(dateKey);
                        recordsByDate[dateKey] = {
                            display: date.toLocaleDateString('zh-TW', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                weekday: 'short'
                            }),
                            records: []
                        };
                    }
                    
                    const medicine = medicines.find(m => m.id === record.medicineId);
                    if (medicine) {
                        if (memberFilter === 'all' || medicine.member === memberFilter) {
                            recordsByDate[dateKey].records.push({
                                ...record,
                                medicineName: medicine.name,
                                dosage: medicine.dosage,
                                member: medicine.member
                            });
                        }
                    }
                });

                const getMemberBadge = (memberId) => {
                    if (memberId === 'self' || memberFilter !== 'all') return '';
                    const member = familyMembers.find(m => m.id === memberId);
                    return member ? ` <span style="background: #e3f2fd; color: #667eea; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${member.name}</span>` : '';
                };

                let html = '';
                let hasRecords = false;
                Object.keys(recordsByDate).sort().reverse().forEach(dateKey => {
                    const day = recordsByDate[dateKey];
                    if (day.records.length === 0) return;
                    
                    hasRecords = true;
                    html += `
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: #666; margin-bottom: 15px; font-size: 16px;">
                                ${day.display}
                            </h4>
                            <div class="med-list">
                                ${day.records.map(record => `
                                    <div class="med-item">
                                        <div class="med-icon" style="background: #4caf50;">âœ“</div>
                                        <div class="med-info">
                                            <div class="med-name">${record.medicineName}${getMemberBadge(record.member)}</div>
                                            <div class="med-dosage">${record.dosage} â€¢ è¨ˆåŠƒæ™‚é–“: ${record.time}</div>
                                        </div>
                                        <div class="med-time">
                                            <div class="time">${record.actualTime || record.time}</div>
                                            <div class="time-label">å¯¦éš›æœç”¨</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                if (!hasRecords) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">ğŸ“‹</div>
                            <p>æ­¤æœŸé–“ç„¡æœè—¥è¨˜éŒ„</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„éŒ¯èª¤:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">âŒ</div>
                        <p>è¼‰å…¥å¤±æ•—ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        // é é¢åˆ‡æ›
        function showPage(page) {
            const pages = ['home', 'medicines', 'schedule', 'history', 'missed', 'settings'];
            pages.forEach(p => {
                document.getElementById(p + 'Page').style.display = p === page ? 'block' : 'none';
            });

            // æ›´æ–°å°èˆªé …ç›®çš„ active ç‹€æ…‹
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                const pageNames = ['home', 'medicines', 'schedule', 'history', 'missed', 'settings'];
                if (pageNames[index] === page) {
                    item.classList.add('active');
                }
            });

            if (page === 'schedule') {
                renderSchedule();
            } else if (page === 'history') {
                loadHistory();
            } else if (page === 'missed') {
                loadMissedReport();
            }
        }

        // ç™»å‡º
        async function handleLogout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                if (reminderCheckInterval) {
                    clearInterval(reminderCheckInterval);
                }
                await auth.signOut();
                window.location.href = 'index.html';
            }
        }

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = type === 'success' ? 'âœ…' : 'âŒ';
            
            document.getElementById('toastIcon').textContent = icon;
            document.getElementById('toastMessage').textContent = message;
            toast.className = `toast ${type} active`;

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }

        // è¼”åŠ©å‡½æ•¸
        function getTimeLabel(time) {
            const hour = parseInt(time.split(':')[0]);
            if (hour < 12) return 'æ—©é¤å¾Œ';
            if (hour < 18) return 'åˆé¤å¾Œ';
            return 'æ™šé¤å¾Œ';
        }

        function getFrequencyText(freq) {
            const map = {
                once: 'æ¯æ—¥ä¸€æ¬¡',
                twice: 'æ¯æ—¥å…©æ¬¡',
                three: 'æ¯æ—¥ä¸‰æ¬¡',
                daily: 'æ¯æ—¥',
                weekly: 'æ¯é€±',
                asNeeded: 'éœ€è¦æ™‚',
                custom: 'è‡ªè¨‚'
            };
            return map[freq] || freq;
        }

        // é»æ“Š modal å¤–éƒ¨é—œé–‰
        window.onclick = function(event) {
            const medicineModal = document.getElementById('addMedicineModal');
            const memberModal = document.getElementById('addMemberModal');
            
            if (event.target === medicineModal) {
                closeAddMedicineModal();
            }
            if (event.target === memberModal) {
                closeAddMemberModal();
            }
        }
    </script>
</body>
</html>
